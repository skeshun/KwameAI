<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>A simple Notes app</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  </head>
  <body><!--navbar should collapse when screensize reduces -->


    <nav class="navbar-dark navbar-expand-lg bg-dark">
        <div class="container-fluid mt-2">
         
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
              <li class="nav-item">
                <a class="nav-link active mx-2" aria-current="page" href="/">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link mx-2" href="#">About</a>
              </li>
             
            </ul>
            <div class="d-flex" role="search">
              <!-- <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> -->
              <a id="alogin" href="/login"><button class="btn btn-warning mx-2" id="login" type="submit">Login</button></a>
              <a id="aregister" href="/register"><button class="btn btn-warning mx-2" id="signup" type="submit">Sign Up</button></a>
            </div>
          </div>
        </div>
      </nav>

      
      <div class="container">
      <h1> Add a Note</h1>
      <form>
        <div class="mb-3">
          <label for="exampleInputtitle1" class="form-label">title of Note</label>
          <input type="text" class="form-control" id="title" aria-describedby="titleHelp">
          <div id="titleHelp" class="form-text">Give your notes a title</div>
        </div>
        <div class="mb-3">
          <label for="desc" class="form-label">Content</label>
          <textarea class="form-control" id="desc"></textarea>
        </div>
        <div class="mb-3 form-check">
          <input type="checkbox" class="form-check-input" id="exampleCheck1">
          <label class="form-check-label" for="exampleCheck1">Check if note is private</label>
        </div>
        <button type="submit" id="submit" class="btn btn-warning">Submit</button>
      </form>
    </div>
    <div class="container my-3 ">
        <h1>Your Notes</h1>
        <div class="mynotes row mt-2">
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
    <script>
    async function postData(url = '', data = {}) {
    // Default options are marked with *
    const response = await fetch(url, {
        method: 'POST', 
        
        headers: {
            'Content-Type': 'application/json'
            // 'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: JSON.stringify(data) // body data type must match "Content-Type" header
    });
   let rdata = await response.json();
   return rdata;
}
    const user= JSON.parse(localStorage.getItem('user'));
   if(user && user.email){
    //change the login and signup button to logout
    let login = document.getElementById('login');
    let alogin = document.getElementById('alogin');
    login.innerHTML = 'Logout';
    alogin.href = '/login';
    //change id of login to logout
    login.id = 'logout';
    let signup = document.getElementById('signup');
    let aregister = document.getElementById('aregister');
    signup.innerHTML = 'refresh';
    aregister.href = '/';

    const notes = postData('/getnotes', {email: user.email});
    notes.then ((notes) =>{
        console.log('notes', notes.notes);
       
        
       notes.notes.forEach(element => {
       //convert date to month day and year format without time 
       var d= new Date(element.date);
       //remove time from date
        var dt = d.toDateString();

        let anote = `
        <div class="card mx-2 mt-4" style="width: 18rem;">
         <div class="card-body">
              <h5 class="card-title">${element.title}</h5>
                <h6 class="card-subtitle mb-2 text-muted">${dt}</h6>
                <p class="card-text">${element.desc}</p>
                <a href="#" id="${element._id}" class="card-link">delete Note</a>
               
        </div>

            `;
            let mynotes = document.querySelector('.mynotes');
            mynotes.innerHTML += anote;
                //if user has no notes
            if(notes.notes.length == 0){
                mynotes.innerHTML = `<div class="alert alert-warning" role="alert">
                You have no notes. Please add a note to continue
                </div>`
            }
            //delete notes in any order
            let deletebtn = document.getElementById(`${element._id}`);
            deletebtn.addEventListener('click', async ()=>{
                let resp = await postData('/deletenote', {id: element._id});
                console.log(resp);
                if(resp){
                    alert('Note deleted successfully');
                    window.location.href = '/';
                }
                else{
                    alert('Note could not be deleted');
                }
            }) 
    })
})

    }
    else {
        //handle mongoose error
        if(user?.error){
            alert(user.error);
        }
        
        alert('Please login to continue');
        window.location.href = '/login';
    }
    
    let submit = document.getElementById('submit');
    submit.addEventListener('click', async ()=>{
        let title = document.getElementById('title').value;
        let desc = document.getElementById('desc').value;
       let private = document.getElementById('exampleCheck1').checked;
        let email = JSON.parse(localStorage.getItem('user'))?.email;
        console.log(title, desc, email);
        let resp = await postData('/addnote', {title, desc, private, email});
        console.log(resp)
        if(resp.success){
            alert('Note added successfully');
            document.getElementById('title').value = '';
            document.getElementById('desc').value = '';
            document.getElementById('exampleCheck1').checked = false;

        }
        else{
            alert('Note not added');
        }
    })
     let logout = document.getElementById('logout');
        logout.addEventListener('click',  ()=>{
           
                alert('Logged out successfully');
                localStorage.removeItem('user');
                window.location.href = '/login';
           
           
        })
   

    </script>

    </script>
  </body>
</html>